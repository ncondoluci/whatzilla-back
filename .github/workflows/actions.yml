name: CI/CD for Whatzilla-Back

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: [self-hosted, backend]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Clean Previous Docker Setup
        run: |
          # Elimina contenedores y vol√∫menes antiguos
          docker compose down --volumes || true
          docker system prune --all --volumes --force
          docker rmi $(docker images -q) || true

    - name: Sync Files to Server
      run: |
        rsync -av --delete --exclude=".git" --exclude=".env" $GITHUB_WORKSPACE/ /home/cantalupe/src/whatzilla-back/

      - name: Deploy Containers with Docker Compose
        run: |
          cd /home/cantalupe/src/whatzilla-back
          docker compose up -d --build 

      - name: View Application Logs
        run: |
          docker logs whatzilla-back
